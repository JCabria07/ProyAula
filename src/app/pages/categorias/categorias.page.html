<ion-content fullscreen>
  <app-navbar></app-navbar>

  <div class="container py-4">

    <!-- Spinner de carga -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">
        <i class="bi bi-hourglass-split me-2"></i>
        Cargando... Por favor espere
      </p>
    </div>

    <!-- Contenido principal -->
    <div *ngIf="!loading">
      <!-- Gráfico -->
      <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
          <h5 class="card-title mb-3">
            <i class="bi bi-pie-chart-fill me-2"></i>
            Distribución de categorías
          </h5>
          <div class="mx-auto" style="max-width: 600px; width: 100%;">
            <app-donutschart></app-donutschart>
          </div>
        </div>
      </div>

      <!-- Separador -->
      <div class="border-top mt-4 pt-3 text-muted small text-center"></div>

      <!-- Formulario -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="bi bi-plus-circle me-2"></i>
            Registrar nueva categoría
          </h5>
          <form [formGroup]="formCategoria" (ngSubmit)="guardarCategoria()">
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-tag me-1"></i>
                Nombre
              </label>
              <input
                formControlName="nombre_categoria"
                class="form-control"
                placeholder="Ej: Tecnología"
              />
            </div>
            <div class="mb-3">
              <label class="form-label">
                <i class="bi bi-card-text me-1"></i>
                Descripción
              </label>
              <textarea
                formControlName="descripcion_categoria"
                class="form-control no-resize"
                rows="2"
                placeholder="Describe la categoría..."
              ></textarea>
            </div>
            <button
              class="btn btn-primary w-100 d-flex align-items-center justify-content-center"
              type="submit"
              [disabled]="formCategoria.invalid"
            >
              <i class="bi bi-save me-2"></i>
              Guardar
            </button>
          </form>
        </div>
      </div>


<!-- Acordeón de categorías / Ionic -->
<ion-accordion-group expand="inset">
  <ion-accordion value="categorias">
    <!-- Header del acordeón -->
    <ion-item slot="header" color="light">
      <ion-icon name="albums-outline" slot="start"></ion-icon>
      <ion-label>Categorías existentes</ion-label>
    </ion-item>

    <!-- Contenido del acordeón -->
    <div class="ion-padding" slot="content">
      <div class="row g-3">
        <div class="col-md-6" *ngFor="let cat of categorias">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">
                <i class="bi bi-tag-fill me-2 text-primary"></i>
                {{ cat.nombre_categoria }}
              </h5>
              <p class="card-text text-muted flex-grow-1">
                {{ cat.descripcion_categoria }}
              </p>
              <div class="d-flex">
                <button class="btn btn-outline-primary w-50 me-2" (click)="abrirModalEditar(cat)">
                  <i class="bi bi-pencil-square me-1"></i> Editar
                </button>
                <button class="btn btn-outline-danger w-50" (click)="eliminarCategoria(cat)">
                  <i class="bi bi-trash me-1"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ion-accordion>
</ion-accordion-group>

<!-- Modal de edición de categoría / Ionic -->
<ion-modal [isOpen]="isEditOpen" (didDismiss)="cerrarModalEditar()">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>
          <ion-icon name="create-outline" slot="start"></ion-icon>
          Editar categoría
        </ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="cerrarModalEditar()">
            <ion-icon name="close-circle"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form [formGroup]="formEditarCategoria">
        <ion-item>
          <ion-label position="floating">
            <ion-icon name="pricetag-outline" slot="start"></ion-icon>
            Nombre
          </ion-label>
          <ion-input formControlName="nombre_categoria"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">
            <ion-icon name="document-text-outline" slot="start"></ion-icon>
            Descripción
          </ion-label>
          <ion-textarea formControlName="descripcion_categoria" rows="3"></ion-textarea>
        </ion-item>
      </form>

      
      <ion-buttons class="ion-justify-content-end ion-margin-top">
        <ion-button color="medium" (click)="cerrarModalEditar()">
          <ion-icon name="close-circle" slot="start"></ion-icon>
          Cancelar
        </ion-button>
        <ion-button color="success" (click)="guardarEdicion()"
                    [disabled]="formEditarCategoria.invalid || !cambioDetectado">
          <ion-icon name="checkmark-circle" slot="start"></ion-icon>
          Aceptar
        </ion-button>
      </ion-buttons>
    </ion-content>
  </ng-template>
</ion-modal>
      <!-- Footer -->
      <app-footer></app-footer>
      <!-- Footer -->
    </div>
  </div>

</ion-content>